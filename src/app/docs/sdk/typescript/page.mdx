# TypeScript SDK

Complete reference for the Consonant TypeScript SDK.

## Installation

```bash
npm install @consonant/sdk
```

## Basic Usage

```typescript
import { Consonant } from '@consonant/sdk'
import OpenAI from 'openai'

const consonant = new Consonant({
  apiKey: process.env.CONSONANT_API_KEY!,
  customerIdExtractor: (ctx) => ctx.userId,
})

const openai = new OpenAI()
const trackedAI = consonant.wrap(openai)
```

## Configuration Options

```typescript
interface ConsonantConfig {
  // Required: Your Consonant API key
  apiKey: string
  
  // Required: Function to extract customer ID from request context
  customerIdExtractor: (context: RequestContext) => string
  
  // Optional: Buffer multiplier for cost estimation (default: 1.2)
  bufferMultiplier?: number
  
  // Optional: Fallback behavior when Consonant is unreachable
  fallbackMode?: 'allow' | 'block' // default: 'allow'
  
  // Optional: Custom endpoint (for self-hosted)
  endpoint?: string
  
  // Optional: Request timeout in milliseconds (default: 5000)
  timeout?: number
}
```

## Supported AI Clients

### OpenAI

```typescript
import OpenAI from 'openai'

const openai = new OpenAI()
const tracked = consonant.wrap(openai)

await tracked.chat.completions.create({
  model: 'gpt-4',
  messages: [{ role: 'user', content: 'Hello!' }]
}, { userId: 'customer_123' })
```

### Anthropic

```typescript
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic()
const tracked = consonant.wrap(anthropic)

await tracked.messages.create({
  model: 'claude-3-opus-20240229',
  max_tokens: 1024,
  messages: [{ role: 'user', content: 'Hello!' }]
}, { userId: 'customer_123' })
```

## Error Handling

```typescript
import { ConsonantError, InsufficientBalanceError } from '@consonant/sdk'

try {
  const response = await trackedAI.chat.completions.create({...})
} catch (error) {
  if (error instanceof InsufficientBalanceError) {
    // Customer ran out of credits
    console.log('Customer balance exhausted:', error.customerId)
  } else if (error instanceof ConsonantError) {
    // Other Consonant-specific errors
    console.log('Consonant error:', error.message)
  } else {
    // AI provider errors pass through unchanged
    throw error
  }
}
```

## Manual Tracking

For advanced use cases, you can track requests manually:

```typescript
// Start tracking
const tracker = await consonant.startRequest({
  customerId: 'customer_123',
  model: 'gpt-4',
  estimatedTokens: 1000,
})

// Make your AI call directly
const response = await openai.chat.completions.create({...})

// Finalize with actual usage
await tracker.finalize({
  promptTokens: response.usage.prompt_tokens,
  completionTokens: response.usage.completion_tokens,
})
```

## TypeScript Types

```typescript
import type {
  ConsonantConfig,
  RequestContext,
  TrackingResult,
  CustomerBalance,
} from '@consonant/sdk'
```
